# 🧭 Milestone MS-ADMIN-01: 관리자 기능 통합 구축 초정밀 명세서

---

## 0️⃣ 기본 정보 (Basic Info)

- **마일스톤 명**: DentiCheck 관리자 통합 운영 시스템 고도화
- **상태**: [x] In Progress (백엔드 핵심 로직 및 DB 구축 완료)
- **핵심 원칙**: 
  - 실시간 헤비 쿼리 금지 (통계 테이블 활용)
  - 목록 가독성 확보 (최신 데이터 1번 부여)
  - 데이터 보존형 삭제 (Soft Delete)

---

## 1️⃣ 데이터베이스 설계 상세 (DB Schema)

### 📊 [신규] 관리자 운영용 테이블 (V7)
```sql
-- 1. 관리자 대시보드 일별 통계 (00:00 자정 갱신 데이터 저장소)
CREATE TABLE admin_daily_stats (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    stats_date DATE NOT NULL UNIQUE,          -- 집계 날짜
    total_users INTEGER NOT NULL DEFAULT 0,    -- 총 이용자 수
    total_dentists INTEGER NOT NULL DEFAULT 0, -- 총 제휴 치과 수
    new_inquiries INTEGER NOT NULL DEFAULT 0,  -- 신규 문의 건수
    weekly_usage INTEGER NOT NULL DEFAULT 0,   -- 최근 7일(월~일) 누적 이용 건수
    user_trend DECIMAL(5, 2) DEFAULT 0.00,     -- 전일 대비 이용자 증가율 (%)
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW()
);

-- 2. 제휴 치과 전용 상품 관리
CREATE TABLE partner_products (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    category VARCHAR(100) NOT NULL, -- 칫솔류, 치약 및 세정제, 치간, 혀 및 구강, 특수케어, 기타
    name VARCHAR(255) NOT NULL,    -- 제품명
    price INTEGER NOT NULL,        -- 가격
    manufacturer VARCHAR(255),     -- 제조회사
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW()
);

-- 3. 제휴 보험 전용 상품 관리
CREATE TABLE insurance_products (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    category VARCHAR(100) NOT NULL, -- 보험 종류
    name VARCHAR(255) NOT NULL,    -- 보험명
    price INTEGER NOT NULL,        -- 보험료
    company VARCHAR(255),          -- 보험회사
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW()
);
```

### 🏥 [참고] 기존 및 연동 테이블 (Core)
- **`users`**: `status` 컬럼(`ACTIVE`, `DORMANT`, `SUSPENDED`, `WITHDRAWN`)을 통해 회원 상태 관리. 삭제 시 `SUSPENDED`로 업데이트.
- **`hospitals`**: 병원 기초 정보(이름, 주소, 연락처, 위경도, 홈페이지 등) 관리.

---

## 2️⃣ 모듈별 상세 요구사항 및 목록 정의

### 📈 <대시보드> 모듈
- **통계 업데이트**: 매일 00:00:00 기준 스케줄러를 통한 `admin_daily_stats` 갱신.
- **상단 4개 지표 카드**:
  1. **총 이용자**: (전날 대비 +00.0% 하단 표시)
  2. **제휴 치과**: (전날 대비 +n 하단 표시)
  3. **신규 문의**: (전날 대비 +n 하단 표시)
  4. **이번 주 이용**: 월요일부터 당일(전날)까지 누적값 (전날 대비 +n 하단 표시)
- **일일 이용자 현황 (막대 차트)**:
  - X축: 월, 화, 수, 목, 금, 토, 일 (각 날짜 포함)
  - 상단: 연도/월 표시
- **주간 이용자 현황 (선 그래프)**:
  - 1주, 2주, 3주, 4주 단위 쿼리 (특정 일자별 브랜칭 가능)
  - **특이점**: 그래프 급상승/급하강 시 Y축 범위를 **물결(~)** 형태로 자동 조절
- **최근 문의 현황 목록 (상세 연동)**:
  - `ID`: 최신이 1번 (등록순 역순, 최신일수록 낮은 번호)
  - `제목`, `날짜`, `상태`(대기/처리중/완료)
  - 문의 클릭 시 상세 페이지로 이동

### 👥 <회원관리> 모듈
- **목록 구성**: `ID`(역순), `회원 닉네임/이메일`, `상태`, `조회/수정/삭제`
- **검색**: 회원 닉네임 또는 구글 이메일 키워드 검색 지원
- **Soft Delete 로직**: 삭제 버튼 클릭 시 레코드를 실제 삭제하지 않고 `userStatusType`을 **`SUSPENDED`**로 변경
  - `ACTIVE`("정상"), `DORMANT`("휴면"), `SUSPENDED`("정지"), `WITHDRAWN`("탈퇴")

### 🏥 <제휴치과 관리> 모듈
- **기능**: 치과 검색, DB 기반 치과별 조회
- **추가 기능**: '추가' 버튼 클릭 시 `hospitals` 스키마(V4 고정) 필드에 맞춘 모달 입력창 제공
- **필드**: ID(역순), 병원명, 주소, 전화번호, 제휴 여부

### 🦷 <제휴상품 관리> 모듈
- **카테고리**: 칫솔류, 치약 및 세정제, 치간, 혀 및 구강, 특수케어(틀니, 구강보습제, 구강유산균, 치면세균막 착색제), 기타(치발기/노리개 젖꼭지:영유아용)
- **상단 구성**: 목록 위에 '추가' 버튼 배치
- **목록 구성**: `ID`(역순), `종류명`, `제품명`, `가격`, `제조회사`, `수정`, `삭제`

### 🛡️ <제휴 보험 상품 관리> 모듈
- **상단 구성**: 목록 위에 '추가' 버튼 배치
- **목록 구성**: `ID`(역순), `종류명`, `보험명`, `가격`, `회사`, `수정`, `삭제`

---

## 3️⃣ 시스템 파일 명세 (File Manifest)

- **[V7__admin_features.sql](file:///c:/DentiCheck/denticheck/api/src/main/resources/db/migration/V7__admin_features.sql)**: 자정 통계 및 상품/보험용 신규 DB 스키마.
- **[admin.graphqls](file:///c:/DentiCheck/denticheck/api/src/main/resources/graphql/schema/admin.graphqls)**: 목록별 검색/필터링 및 역순 ID 반환을 위한 GraphQL 명세.
- **[AdminResolver.java](file:///c:/DentiCheck/denticheck/api/src/main/java/com/denticheck/api/graphql/resolver/AdminResolver.java)**: 프론트엔드 요청을 처리하는 컨트롤러 레이어.
- **[AdminServiceImpl.java](file:///c:/DentiCheck/denticheck/api/src/main/java/com/denticheck/api/domain/admin/service/impl/AdminServiceImpl.java)**: 비즈니스 로직 및 목록 역순 ID 산출 로직 구현.
- **[AdminDTOs.java](file:///c:/DentiCheck/denticheck/api/src/main/java/com/denticheck/api/domain/admin/dto/AdminDTOs.java)**: 목록 데이터 및 차트 데이터 전송 객체.
- **[JWTFilter.java](file:///c:/DentiCheck/denticheck/api/src/main/java/com/denticheck/api/security/jwt/filter/JWTFilter.java)**: 테스트용 Bearer 토큰 인식 및 관리자 권한 부여 필터.
